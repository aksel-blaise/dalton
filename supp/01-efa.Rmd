# Elliptic Fourier Analysis

Prior to running the full 3D geometric morphometric (3DGM) analysis, an elliptic Fourier analysis was conducted to identify differences in Dalton projectile point shape in plan view. These data inform the subsequent landmarking protocol used in the 3DGM analysis.

Those 2D images (jpegs) used in the EFA were generated as screen captures of the 3D dataset, and are oriented with the same base alignment. Each image was masked using Photoshop to render a binary (black/white) image.

## Load packages + data

```{r load.packages, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# load packages
library(here)
library(wesanderson)
library(Momocs)

# read images + attribute data
jpg.list <- list.files(here("/jpeg"), full.names = TRUE)
att.data <- read.csv("qdata.csv", header = TRUE, as.is = TRUE)

# attributes to factors
att.data$heart.out <- as.factor(att.data$heart.out)
att.data$heart.reg <- as.factor(att.data$heart.reg)
att.data$bev <- as.factor(att.data$bev)
att.data$bev.type <- as.factor(att.data$bev.type)
```

## Generate outlines

```{r outlines + attribues, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
outlines <- jpg.list %>%
  import_jpg()

data.out <- Out(outlines, 
         fac = att.data)

norm.outlines <- data.out %>% 
  coo_center %>%
  coo_scale()
```

## Stack and panels

```{r stack.panel, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# outline stack
pile(norm.outlines)

# mosaics
# in/out of heartland
mosaic(data.out, ~heart.out, asp = 1, palette = pal_qual_Dark2)
# heartland regions (heartland, interior, and northern periphery)
mosaic(data.out, ~heart.reg, asp = 1, palette = pal_qual_Dark2)
# beveled or not
mosaic(data.out, ~bev, asp = 1, palette = pal_qual_Dark2)
# bevel type
mosaic(data.out, ~bev.type, asp = 1, palette = pal_qual_Dark2)
```

## Calibrate harmonic + EFA

```{r cal.harm, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}

calibrate_harmonicpower_efourier(norm.outlines, nb.h = 20)
calibrate_reconstructions_efourier(norm.outlines, range = 1:10) #10 harmonics

efa.outlines <- efourier(norm.outlines, nb.h = 10, norm = TRUE)

pca.outlines <- PCA(efa.outlines)
```

## PCA

```{r pca.plot, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# pca 
scree_plot(pca.outlines)

# plot pca
# heartland in/out
plot_PCA(pca.outlines, morphospace_position = "range", ~heart.out, palette = pal_qual_Dark2)
# heartland region
plot_PCA(pca.outlines, morphospace_position = "range", ~heart.reg, palette = pal_qual_Dark2)
# beveled or not
plot_PCA(pca.outlines, morphospace_position = "range", ~bev, palette = pal_qual_Dark2)
# bevel type
plot_PCA(pca.outlines, morphospace_position = "range", ~bev.type, palette = pal_qual_Dark2)

# contribution of each pc
boxplot(pca.outlines, ~heart.out, nax = 1:5, palette = pal_qual_Dark2)
boxplot(pca.outlines, ~heart.reg, nax = 1:5, palette = pal_qual_Dark2)
boxplot(pca.outlines, ~bev, nax = 1:5, palette = pal_qual_Dark2)
boxplot(pca.outlines, ~bev.type, nax = 1:5, palette = pal_qual_Dark2)

# mean shape + 2sd for each pc
PCcontrib(pca.outlines, nax = 1:10)
```

## MANOVA + MANOVA_PW

```{r manova, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# manova + manova_pw
MANOVA(pca.outlines, 'heart.out')
MANOVA(pca.outlines, 'heart.reg')
MANOVA_PW(pca.outlines, 'heart.reg')
MANOVA(pca.outlines, 'bev')
MANOVA(pca.outlines, 'bev.type')
MANOVA_PW(pca.outlines, 'bev.type')
```

## Mean shapes

```{r ms1, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE, fig.cap="Mean shapes for in (H) and out (N) of the heartland."}
# mean shapes
ms.1 <- MSHAPES(efa.outlines, ~heart.out)
plot_MSHAPES(ms.1, size = 0.75)
```

```{r ms2, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE, fig.cap="Mean shapes for heartland (H), interior (I), and northern periphery (P)."}
# mean shapes
ms.2 <- MSHAPES(efa.outlines, ~heart.reg)
plot_MSHAPES(ms.2, size = 0.75)
```

```{r ms3, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE, fig.cap="Mean shapes for beveled (y), and not beveled (n)."}
# mean shapes
ms.3 <- MSHAPES(efa.outlines, ~bev)
plot_MSHAPES(ms.3, size = 0.75)
```

```{r ms4, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE, fig.cap="Mean shapes for alternate, unifacial.bimarginal, and no.bevel."}
# mean shapes
ms.4 <- MSHAPES(efa.outlines, ~bev.type)
plot_MSHAPES(ms.4, size = 0.75)
```
