# Analysis

## Generalised Procrustes Analysis

```{r gpa, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# library(devtools)
# devtools::install_github("geomorphR/geomorph", ref = "Stable", build_vignettes = TRUE)
library(geomorph)
library(wesanderson)
setwd(getwd())

# read GM data
source('readmulti.csv.R')

# read .csv files
setwd("./data")
filelist <- list.files(pattern = ".csv")
coords <- readmulti.csv(filelist)
setwd("../")

# read qualitative data
qdata <- read.csv("qdata.csv",header=TRUE,row.names=1)
qdata <- qdata[match(dimnames(coords)[[3]],rownames(qdata)),]
qdata

# gpa
Y.gpa <- gpagen(coords, PrinAxes = TRUE, ProcD = TRUE, Proj = TRUE, print.progress = FALSE)
# plot consensus configuration
plot(Y.gpa$consensus[,c("X", "Y")], asp = 1, pch = 20)

# gpa plot
# knitr::include_graphics('images/gpa3d.png')
# fig.cap="Results of generalized Procrustes analysis."

# geomorph data frame
gdf <- geomorph.data.frame(shape = Y.gpa$coords, size = Y.gpa$Csize, heart = qdata$heart.out, hreg = qdata$heart.reg)

# attributes for boxplots
csz <- Y.gpa$Csize # centroid size
heart <- qdata$heart.out # heartland in/out
hreg <- qdata$heart.reg # heartland region

# boxplot of Dalton point centroid size by in/out heartland
boxplot(csz~heart,
        names = c("H","N"), # heartland (H), and not heartland (N)
        xlab = "Heartland",
        ylab = "Centroid Size",
        col = wes_palette("Moonrise2"),
        )
fig.cap = "Boxplot of centroid size by Heartland (in/out)."

# boxplot of Dalton point centroid size by heartland + regions
boxplot(csz~hreg,
        names = c("H","I","P"), # heartland (H), interior (I), and northern periphery (P)
        xlab = "Heartland Region",
        ylab = "Centroid Size",
        col = wes_palette("Moonrise2"),
        )
fig.cap = "Boxplot of centroid size by Heartland region."
```

## Principal Components Analysis

```{r pca, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# principal components analysis
pca<-gm.prcomp(Y.gpa$coords)
summary(pca)

# set plot parameters to plot by heartland in (H) and out (N)
pch.gps.heart <- c(15,17)[as.factor(heart)]
col.gps.heart <- wes_palette("Moonrise2")[as.factor(heart)]
col.hull <- c("#798E87","#C27D38")
# plot pca by heartland in (H) and out (N)
pc.plot1 <- plot(pca, asp = 1,
                  pch = pch.gps.heart,
                  col = col.gps.heart)
                  shapeHulls(pc.plot1, 
                             groups = heart,
                             group.cols = col.hull)
                  
# set plot parameters to plot by heartland + regions
pch.gps.hreg <- c(15,17,18)[as.factor(hreg)]
col.gps.hreg <- wes_palette("Moonrise2")[as.factor(hreg)]
col.hull.2 <- c("#798E87","#CCC591","#C27D38")
# plot pca by heartland + regions
pc.plot2 <- plot(pca, asp = 1,
                  pch = pch.gps.hreg,
                  col = col.gps.hreg)
                  shapeHulls(pc.plot2, 
                             groups = hreg,
                             group.cols = col.hull.2)
```

## Define models

```{r define-models, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# allometry
fit.size <- procD.lm(shape ~ size, data = gdf, print.progress = FALSE, iter = 9999)
# allometry - common allometry, different means -> heart.out
fit.sz.cheart <- procD.lm(shape ~ size + heart, data = gdf, print.progress = FALSE, iter = 9999)
# allometry - unique allometries -> heart.out
fit.sz.uheart <- procD.lm(shape ~ size * heart, data = gdf, print.progress = FALSE, iter = 9999)
# allometry - common allometry, different means -> heart.reg
fit.sz.chreg <- procD.lm(shape ~ size + hreg, data = gdf, print.progress = FALSE, iter = 9999)
# allometry - unique allometries -> heart.reg
fit.sz.uhreg <- procD.lm(shape ~ size * hreg, data = gdf, print.progress = FALSE, iter = 9999)

# size as a function of group?
fit.sizeheart <- procD.lm(size ~ heart, data = gdf, print.progress = FALSE, iter = 9999)
fit.sizehreg <- procD.lm(size ~ hreg, data = gdf, print.progress = FALSE, iter = 9999)

# shape as a function of group?
fit.shapeheart <- procD.lm(shape ~ heart, data = gdf, print.progress = FALSE, iter = 9999)
fit.shapehreg <- procD.lm(shape ~ hreg, data = gdf, print.progress = FALSE, iter = 9999)
```

## Allometry

```{r allometry, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# allometry - does shape change with size?
anova(fit.size)

# heart.out
anova(fit.sz.cheart)
anova(fit.sz.uheart)
anova(fit.sz.cheart, fit.sz.uheart, print.progress = FALSE)

# heart.reg
anova(fit.sz.chreg)
anova(fit.sz.uhreg)
anova(fit.sz.chreg, fit.sz.uhreg, print.progress = FALSE)

# allometry plots
# regscore (Drake and Klingenberg 2008)
plot(fit.size, type = "regression", reg.type = "RegScore", predictor = log(gdf$size), pch = pch.gps.heart, col = col.gps.heart)
plot(fit.size, type = "regression", reg.type = "RegScore", predictor = log(gdf$size), pch = pch.gps.hreg, col = col.gps.hreg)

# common allometric component (Mitteroecker 2004)
plotAllometry(fit.size, size = gdf$size, logsz = TRUE, method = "CAC", pch = pch.gps.heart, col = col.gps.heart)
plotAllometry(fit.size, size = gdf$size, logsz = TRUE, method = "CAC", pch = pch.gps.hreg, col = col.gps.hreg)

# size-shape pca (Mitteroecker 2004)
plotAllometry(fit.size, size = gdf$size, logsz = TRUE, method = "size.shape", pch = pch.gps.heart, col = col.gps.heart)
plotAllometry(fit.size, size = gdf$size, logsz = TRUE, method = "size.shape", pch = pch.gps.hreg, col = col.gps.hreg)

# predline (Adams and Nistri 2010)
plotAllometry(fit.sz.uheart, size = gdf$size, logsz = TRUE, method = "PredLine", pch = pch.gps.heart, col = col.gps.heart)
plotAllometry(fit.sz.uhreg, size = gdf$size, logsz = TRUE, method = "PredLine", pch = pch.gps.hreg, col = col.gps.hreg)
```

## Size/Shape ~ Group?

```{r szshpinc, out.width = "100%", dpi = 300, echo=TRUE, warning=FALSE}
# ANOVA: does Dalton point size differ in/out of heartland?
anova(fit.sizeheart)
# ANOVA: does Dalton point shape differ in/out of Heartland?
anova(fit.shapeheart)

# ANOVA: does Dalton point sizes differ across heartland regions?
anova(fit.sizehreg)
# pairwise comparison of LS means = which differ?
sz.hreg <- pairwise(fit.sizehreg, groups = qdata$heart.reg)
summary(sz.hreg, confidence = 0.95, test.type = "dist")
# pairwise distance between variances = standardization?
summary(sz.hreg, confidence = 0.95, test.type = "var")

# ANOVA: does Dalton point shape differ across heartland + regions?
anova(fit.shapehreg)
# pairwise comparison of LS means = which differ?
sh.hreg <- pairwise(fit.shapehreg, groups = qdata$heart.reg)
summary(sh.hreg, confidence = 0.95, test.type = "dist")
# pairwise distance between variances = standardization?
summary(sh.hreg, confidence = 0.95, test.type = "var")
```

## Morphological disparity

```{r m-disparity}
# morphological disparity: does Dalton point size display greater variation among individuals?
# in/out of heartland
morphol.disparity(fit.sizeheart, groups = qdata$heart.out, data = gdf, print.progress = FALSE, iter = 9999)
# heartland + regions
morphol.disparity(fit.sizehreg, groups = qdata$heart.reg, data = gdf, print.progress = FALSE, iter = 9999)

# morphological disparity: does Dalton point shape display greater variation among individuals?
# in/out of heartland
morphol.disparity(fit.shapeheart, groups = qdata$heart.out, data = gdf, print.progress = FALSE, iter = 9999)
# heartland + regions
morphol.disparity(fit.shapehreg, groups = qdata$heart.reg, data = gdf, print.progress = FALSE, iter = 9999)
```

## Mean shapes

```{r m-shapes}
# subset landmark coordinates to produce mean shapes by site
# new.coords <- coords.subset(A = Y.gpa$coords, group = qdata$heart)
# names(new.coords)
# group shape means
# mean <- lapply(new.coords, mshape)
# plot(mean$vv)
# mean shapes
#knitr::include_graphics('images/dalton-mshape.png')
#fig.cap = "Mean shapes for Dalton points by region"
# end of code
```